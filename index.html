<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Smart AgriAdvisor</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0;background:#f7f7f7;color:#222}
  header{background:#2b6cb0;color:white;padding:18px 14px;text-align:center;font-size:20px;font-weight:700}
  .container{padding:14px;max-width:720px;margin:0 auto}
  .card{background:white;padding:12px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.08);margin-bottom:12px}
  label{display:block;font-weight:600;margin-bottom:6px}
  .row{display:flex;gap:8px;flex-wrap:wrap}
  button{background:#2b6cb0;color:white;border:none;padding:10px 12px;border-radius:6px;cursor:pointer}
  button.secondary{background:#38a169}
  button.gray{background:#718096}
  select,input{padding:8px;border:1px solid #ddd;border-radius:6px;width:100%}
  .status{font-weight:700;margin-top:6px}
  .result{color:#c53030;font-weight:700;margin-top:8px}
  .small{font-size:13px;color:#666}
  .controls .btn{flex:1;min-width:110px}
  .topline{display:flex;gap:8px;align-items:center}
  pre {background:#0f1724;color:#e6eef8;padding:8px;border-radius:6px;overflow:auto}
</style>
</head>
<body>
<header>Smart AgriAdvisor (Web)</header>
<div class="container">

  <!-- ESP32 Connection -->
  <div class="card">
    <label>ESP32 Connection</label>
    <div class="row">
      <input id="espIp" placeholder="192.168.4.1" value="192.168.4.1"/>
      <button id="btnConnect">Connect</button>
      <button id="btnDisconnect" class="gray">Disconnect</button>
    </div>
    <div class="small">Connect phone & ESP32 to same network (or ESP32 AP mode).</div>
    <span id="loadMsg" class="small"></span>
  </div>

  <!-- Soil Readings -->
  <div class="card">
    <label>Soil Readings</label>
    <div id="lblPH">pH: --</div>
    <div id="lblMoist">Moisture: --</div>
    <div id="lblTemp">Temp: --</div>
    <div class="row" style="margin-top:8px">
      <button id="btnTakeReading">Take Soil Reading</button>
      <button id="btnRefreshReading" class="gray">Refresh Reading</button>
    </div>
  </div>

  <!-- Crop Selection -->
  <div class="card">
    <label>Crop Selection</label>
    <select id="cropSelect"><option value="">-- Load crops --</option></select>
    <div class="row controls" style="margin-top:8px">
      <button id="btnCheck" class="btn">Check Suitability</button>
      <button id="btnAI" class="btn secondary">AI Mode (Top suggestions)</button>
    </div>
    <div id="lblResult" class="result"></div>
  </div>

  <!-- 🌍 Translator -->
  <div class="card">
    <label>Translator (Advice)</label>
    <div class="row">
      <select id="langSelect">
        <option value="en">English</option>
        <option value="hi">Hindi</option>
        <option value="te">Telugu</option>
      </select>
      <button id="btnTranslate">Translate</button>
    </div>
    <div id="lblTranslated" class="small"></div>
  </div>

  <!-- ☁ Weather -->
  <div class="card">
    <label>Weather-based Advice</label>
    <input id="city" placeholder="Enter City"/>
    <button id="btnWeather">Get Weather Advice</button>
    <div id="lblWeather" class="small"></div>
  </div>

  <!-- 💰 Profit Estimator -->
  <div class="card">
    <label>Profit Estimator</label>
    <div class="row">
      <input id="yieldInput" placeholder="Enter Yield (kg)" type="number"/>
      <button id="btnProfit">Estimate Profit</button>
    </div>
    <div id="lblProfit" class="small"></div>
  </div>

  <!-- Robot Controls -->
  <div class="card">
    <label>Robot Controls (Wi-Fi HTTP)</label>
    <div class="row" style="margin-bottom:8px">
      <button class="btn" data-act="forward">Forward</button>
      <button class="btn" data-act="left">Left</button>
      <button class="btn" data-act="stop">Stop</button>
      <button class="btn" data-act="right">Right</button>
      <button class="btn" data-act="backward">Backward</button>
      <button class="btn" data-act="servoDip">Dip Servo</button>
      <button class="btn" data-act="servoLift">Lift Servo</button>
    </div>
  </div>

  <!-- Debug -->
  <div class="card">
    <label>Debug / Raw Response</label>
    <pre id="debug">No data yet</pre>
  </div>

</div>

<script>
/* ---- Crop DB ---- */
let cropDB = []; 
let phVal=0, moistVal=0, tempVal=0;
let espConnected = false;
let espUrl = "";

function fallbackDB(){
  cropDB = [
    ["Wheat",6,7.5,40,15,20],["Rice",5.5,7,60,20,25],["Maize",5.5,7,50,18,18],
    ["Tomato",5.5,7,30,20,30],["Potato",5.5,7,30,15,12],["Cotton",6,8,50,22,40]
    // ... keep your 50 crops, add last column = avg price per kg
  ];
  populateCropSelect();
  setStatus("Loaded fallback crops");
}
function populateCropSelect(){
  const sel=document.getElementById('cropSelect');
  sel.innerHTML="";
  for(let row of cropDB){
    const opt=document.createElement('option');
    opt.value=row[0]; opt.text=row[0];
    sel.appendChild(opt);
  }
}
function setStatus(t){document.getElementById('loadMsg').innerText=t;}

/* ---- ESP32 Connect ---- */
document.getElementById('btnConnect').onclick=()=>{
  const ip=document.getElementById('espIp').value.trim();
  if(!ip){alert("Enter ESP32 IP");return;}
  espUrl=ip.startsWith("http")?ip:"http://"+ip;
  espConnected=true;setStatus("Connected to "+espUrl);
};
document.getElementById('btnDisconnect').onclick=()=>{espConnected=false;espUrl="";setStatus("Disconnected");};

async function callEsp(path){
  if(!espConnected){alert("ESP32 not connected!");return null;}
  try{const r=await fetch(espUrl+path);const txt=await r.text();document.getElementById('debug').innerText=txt;return txt;}
  catch(e){document.getElementById('debug').innerText="ERROR: "+e;return null;}
}

/* ---- Sensor Parse ---- */
function parseSensorText(txt){
  const nums=txt.match(/-?\d+(\.\d+)?/g);
  if(nums&&nums.length>=3){phVal=parseFloat(nums[0]);moistVal=parseFloat(nums[1]);tempVal=parseFloat(nums[2]);}
  document.getElementById('lblPH').innerText="pH: "+phVal;
  document.getElementById('lblMoist').innerText="Moisture: "+moistVal;
  document.getElementById('lblTemp').innerText="Temp: "+tempVal;
}
document.getElementById('btnTakeReading').onclick=async()=>{const t=await callEsp("/readSensors");if(t)parseSensorText(t);};
document.getElementById('btnRefreshReading').onclick=async()=>{const t=await callEsp("/readSensors");if(t)parseSensorText(t);};

/* ---- Crop Suitability ---- */
document.getElementById('btnCheck').onclick=()=>{
  const crop=document.getElementById('cropSelect').value;if(!crop){alert("Pick a crop");return;}
  const row=cropDB.find(r=>r[0]==crop);if(!row)return;
  const [n,minPH,maxPH,minM,minT]=row;
  const ok=phVal>=minPH&&phVal<=maxPH&&moistVal>=minM&&tempVal>=minT;
  document.getElementById('lblResult').innerText=ok?`✅ ${n} is Suitable`:`❌ ${n} Not Suitable`;
};
document.getElementById('btnAI').onclick=()=>{
  const list=cropDB.filter(r=>phVal>=r[1]&&phVal<=r[2]&&moistVal>=r[3]&&tempVal>=r[4]).map(r=>r[0]);
  document.getElementById('lblResult').innerText=list.length?"AI Suggests: "+list.slice(0,5).join(", "):"No matches";
};

/* ---- Translator ---- */
document.getElementById('btnTranslate').onclick=async()=>{
  const text=document.getElementById('lblResult').innerText;
  const lang=document.getElementById('langSelect').value;
  if(!text){alert("No text to translate!");return;}
  try{
    const res=await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=en|${lang}`);
    const data=await res.json();
    document.getElementById('lblTranslated').innerText="🔄 "+data.responseData.translatedText;
  }catch(e){document.getElementById('lblTranslated').innerText="Translation error";}
};

/* ---- Weather ---- */
document.getElementById('btnWeather').onclick=async()=>{
  const city=document.getElementById('city').value;
  if(!city){alert("Enter city");return;}
  try{
    const apiKey="demo"; // replace with your OpenWeatherMap key
    const res=await fetch(`https://api.openweathermap.org/data/2.5/weather?q=${city}&appid=${apiKey}&units=metric`);
    const d=await res.json();
    const t=d.main.temp;const hum=d.main.humidity;
    let advice="Weather: "+t+"°C, Humidity: "+hum+"%. ";
    if(hum<40)advice+="Irrigation needed 💧"; else advice+="No irrigation needed ✅";
    document.getElementById('lblWeather').innerText=advice;
  }catch(e){document.getElementById('lblWeather').innerText="Weather fetch error";}
};

/* ---- Profit Estimator ---- */
document.getElementById('btnProfit').onclick=()=>{
  const crop=document.getElementById('cropSelect').value;
  const yieldKg=parseFloat(document.getElementById('yieldInput').value);
  if(!crop||!yieldKg){alert("Pick crop and enter yield");return;}
  const row=cropDB.find(r=>r[0]==crop);
  if(!row||row.length<6){document.getElementById('lblProfit').innerText="Rate not found";return;}
  const price=row[5];const profit=yieldKg*price;
  document.getElementById('lblProfit').innerText=`Est. Profit: ₹${profit} (at ₹${price}/kg)`;
};

/* Init */
window.onload=fallbackDB;
</script>
</body>
</html>
