<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Smart AgriAdvisor ‚Äî Dual Mode</title>
<style>
  body{font-family:Arial,Helvetica,sans-serif;margin:0;padding:0;background:#f7f7f7;color:#222}
  header{background:#2b6cb0;color:#fff;padding:16px;text-align:center;font-size:20px;font-weight:700}
  .container{padding:14px;max-width:920px;margin:12px auto}
  .card{background:#fff;padding:12px;border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,0.06);margin-bottom:12px}
  label{display:block;font-weight:700;margin-bottom:8px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,select,button,textarea{padding:8px;border-radius:6px;border:1px solid #ddd;font-size:14px}
  button{background:#2b6cb0;color:#fff;border:none;cursor:pointer}
  button.gray{background:#718096}
  button.small{padding:6px 8px;font-size:13px}
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
  .stat{font-weight:700;margin-top:6px}
  .result{color:#0b6b35;font-weight:700;margin-top:8px}
  pre{background:#0f1724;color:#e6eef8;padding:10px;border-radius:6px;overflow:auto;max-height:220px}
  .small{font-size:13px;color:#666}
</style>
</head>
<body>
<header>Smart AgriAdvisor ‚Äî Dual Mode</header>
<div class="container">

  <!-- Wi-Fi -->
  <div class="card">
    <label>Wi-Fi Connection</label>
    <div class="row">
      <input id="espIp" value="192.168.4.1" placeholder="ESP32 IP"/>
      <button id="btnConnect" class="small">Connect</button>
      <button id="btnDisconnect" class="small gray">Disconnect</button>
    </div>
    <div id="connStatus" class="small">Wi-Fi: Not connected</div>
  </div>

  <!-- Bluetooth -->
  <div class="card">
    <label>Bluetooth Connection</label>
    <div class="row">
      <button id="btnBTList" class="small">üîç List Devices</button>
      <select id="btDevices"></select>
      <button id="btnBTConnect" class="small">Connect</button>
      <button id="btnBTDisconnect" class="small gray">Disconnect</button>
    </div>
    <div id="btStatus" class="small">BT: Not connected</div>
  </div>

  <!-- Sensors -->
  <div class="card">
    <label>Soil & Environment</label>
    <div class="grid">
      <div><div class="stat">pH</div><div id="lblPH">--</div></div>
      <div><div class="stat">Moisture (%)</div><div id="lblMoist">--</div></div>
      <div><div class="stat">Temp (¬∞C)</div><div id="lblTemp">--</div></div>
      <div><div class="stat">Humidity (%)</div><div id="lblHum">--</div></div>
    </div>
    <div class="row" style="margin-top:10px">
      <button id="btnRead" class="small">Take Soil Reading</button>
      <button id="btnRefresh" class="small gray">Refresh</button>
    </div>
    <div id="logArea" class="small" style="white-space:pre-wrap;margin-top:8px"></div>
  </div>

  <!-- Crops -->
  <div class="card">
    <label>Crop Suitability & AI</label>
    <div class="row">
      <select id="cropSelect"></select>
      <button id="btnCheck" class="small">Check</button>
      <button id="btnAI" class="small gray">AI Suggest</button>
    </div>
    <div id="lblResult" class="result"></div>
    <div id="aiList" class="small"></div>
  </div>

  <!-- Robot -->
  <div class="card">
    <label>Robot Controls</label>
    <div class="row">
      <button data-cmd="forward">‚¨Ü Forward</button>
      <button data-cmd="left">‚¨Ö Left</button>
      <button data-cmd="stop" class="gray">üõë Stop</button>
      <button data-cmd="right">‚û° Right</button>
      <button data-cmd="backward">‚¨á Backward</button>
    </div>
  </div>

  <!-- Translator -->
  <div class="card">
    <label>Translator</label>
    <div class="row">
      <input id="txtTranslate" placeholder="English text"/>
      <select id="langSelect">
        <option value="hi">Hindi</option>
        <option value="te">Telugu</option>
      </select>
      <button id="btnTranslate" class="small">Translate</button>
    </div>
    <div id="lblTranslation" class="small"></div>
  </div>

  <!-- Weather -->
  <div class="card">
    <label>Weather</label>
    <div class="row">
      <input id="city" placeholder="Enter city"/>
      <button id="btnWeather" class="small">Check</button>
    </div>
    <div id="lblWeather" class="small"></div>
  </div>

  <!-- Profit -->
  <div class="card">
    <label>Profit Estimator</label>
    <div class="row">
      <select id="cropProfit"></select>
      <input id="yieldInput" placeholder="Yield (q)"/>
      <button id="btnProfit" class="small">Estimate</button>
    </div>
    <div id="lblProfit" class="result"></div>
  </div>

  <!-- Debug -->
  <div class="card">
    <label>Debug</label>
    <pre id="debug">No data</pre>
  </div>
</div>

<script src="cordova.js"></script>
<script>
/* --- Crop DB (short for demo) --- */
const cropDB = [
  ["Wheat",6,7.5,40,15,2000],["Rice",5.5,7,60,20,1800],["Maize",5.5,7,50,18,1500],
  ["Tomato",5.5,7,30,20,1500],["Onion",6,7,35,18,1400]
];
let phVal, moistVal, tempVal, humVal;

/* Populate crops */
function populate(){
  let sel=document.getElementById("cropSelect"), sel2=document.getElementById("cropProfit");
  cropDB.forEach(r=>{
    sel.add(new Option(r[0],r[0]));
    sel2.add(new Option(r[0],r[0]));
  });
}
populate();

/* --- Wi-Fi --- */
let espUrl="", connected=false;
document.getElementById("btnConnect").onclick=async()=>{
  espUrl="http://"+document.getElementById("espIp").value.trim();
  try{let r=await fetch(espUrl+"/"); if(r.ok){connected=true;document.getElementById("connStatus").innerText="Wi-Fi: Connected";}}
  catch(e){document.getElementById("connStatus").innerText="Wi-Fi: Failed";}
};
document.getElementById("btnDisconnect").onclick=()=>{connected=false;document.getElementById("connStatus").innerText="Wi-Fi: Disconnected";};

/* --- Bluetooth (Cordova plugin required) --- */
let btConnected=false;
document.getElementById("btnBTList").onclick=()=>{
  bluetoothSerial.list(devices=>{
    let sel=document.getElementById("btDevices"); sel.innerHTML="";
    devices.forEach(d=> sel.add(new Option(d.name,d.id)));
  });
};
document.getElementById("btnBTConnect").onclick=()=>{
  let id=document.getElementById("btDevices").value;
  bluetoothSerial.connect(id,()=>{btConnected=true;document.getElementById("btStatus").innerText="BT: Connected";},()=>alert("BT Failed"));
};
document.getElementById("btnBTDisconnect").onclick=()=>{
  bluetoothSerial.disconnect(()=>{btConnected=false;document.getElementById("btStatus").innerText="BT: Disconnected";});
};

/* --- Sensors --- */
async function fetchSensors(){
  if(connected){
    let r=await fetch(espUrl+"/readSensors"); let j=await r.json();
    updateSensors(j);
  } else if(btConnected){
    bluetoothSerial.write("R\n");
    bluetoothSerial.subscribe("\n",data=>{try{let j=JSON.parse(data);updateSensors(j);}catch(e){}});
  } else alert("Connect first (Wi-Fi or BT)");
}
function updateSensors(j){
  phVal=j.pH; moistVal=j.Moist; tempVal=j.Temp; humVal=j.Hum;
  document.getElementById("lblPH").innerText=phVal;
  document.getElementById("lblMoist").innerText=moistVal+" %";
  document.getElementById("lblTemp").innerText=tempVal+" ¬∞C";
  document.getElementById("lblHum").innerText=humVal+" %";
  document.getElementById("debug").innerText=JSON.stringify(j);
}
document.getElementById("btnRead").onclick=fetchSensors;
document.getElementById("btnRefresh").onclick=fetchSensors;

/* --- Crops --- */
document.getElementById("btnCheck").onclick=()=>{
  let crop=document.getElementById("cropSelect").value;
  let r=cropDB.find(x=>x[0]==crop);
  if(r && phVal>=r[1]&&phVal<=r[2]&&moistVal>=r[3]&&tempVal>=r[4])
    document.getElementById("lblResult").innerText="‚úÖ Suitable for "+crop;
  else document.getElementById("lblResult").innerText="‚ùå Not Suitable";
};
document.getElementById("btnAI").onclick=()=>{
  let list=cropDB.filter(r=>phVal>=r[1]&&phVal<=r[2]&&moistVal>=r[3]&&tempVal>=r[4]);
  document.getElementById("aiList").innerText=list.length?"AI Suggests: "+list.map(x=>x[0]).join(", "):"No suitable crops";
};

/* --- Translator --- */
document.getElementById("btnTranslate").onclick=async()=>{
  let txt=document.getElementById("txtTranslate").value, lang=document.getElementById("langSelect").value;
  let r=await fetch(`https://api.mymemory.translated.net/get?q=${encodeURIComponent(txt)}&langpair=en|${lang}`);
  let j=await r.json(); document.getElementById("lblTranslation").innerText=j.responseData.translatedText;
};

/* --- Weather --- */
document.getElementById("btnWeather").onclick=async()=>{
  let city=document.getElementById("city").value;
  let r=await fetch(`https://wttr.in/${city}?format=%t+%h+%w`); let t=await r.text();
  document.getElementById("lblWeather").innerText=t;
};

/* --- Profit --- */
document.getElementById("btnProfit").onclick=()=>{
  let crop=document.getElementById("cropProfit").value;
  let y=parseFloat(document.getElementById("yieldInput").value||0);
  let r=cropDB.find(x=>x[0]==crop);
  if(r) document.getElementById("lblProfit").innerText="Profit: ‚Çπ"+(y*r[5]).toLocaleString();
};
</script>
</body>
</html>
